<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>模型训练与推理</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>
    <style>
      body {
        font-family: 'Inter', sans-serif;
      }
      .toggle-checkbox:checked {
        right: 0;
        border-color: #4f46e5;
      }
      .toggle-checkbox:checked + .toggle-label {
        background-color: #4f46e5;
      }
      .transition-transform {
        transition: transform 0.3s ease-in-out;
      }
      .rotate-180 {
        transform: rotate(180deg);
      }
    </style>
  </head>
  <body class="bg-gray-100 text-gray-800">
    <div class="container mx-auto p-4 md:p-8">
      <header class="mb-8">
        <h1 class="text-3xl md:text-4xl font-bold text-gray-900">模型训练与推理面板</h1>
        <p class="text-gray-600 mt-2">实时监控训练过程，或对模型进行推理验证。</p>
      </header>

      <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
        <!-- 左侧：控制面板 -->
        <div class="lg:col-span-1 space-y-8">
          <!-- 超参数设置 -->
          <div class="bg-white rounded-xl shadow-lg overflow-hidden">
            <div class="flex justify-between items-center p-6 cursor-pointer" id="hyperparams-header">
              <h2 class="text-2xl font-bold">超参数设置</h2>
              <svg id="hyperparams-toggle-icon" class="w-6 h-6 text-gray-500 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
              </svg>
            </div>
            <div id="hyperparams-content" class="px-6 pb-6">
              <div id="hyperparams-form" class="space-y-6">
                <!-- 内容与之前相同 -->
                <div>
                  <label for="epochs" class="block text-sm font-medium text-gray-700">训练轮次 (Epochs)</label>
                  <input type="number" id="epochs" value="5" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm p-2" />
                </div>
                <div>
                  <label for="batch-size" class="block text-sm font-medium text-gray-700">批处理大小 (Batch Size)</label>
                  <input type="number" id="batch-size" value="32" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm p-2" />
                </div>
                <div>
                  <label for="num-workers" class="block text-sm font-medium text-gray-700">工作进程数 (Num Workers)</label>
                  <input type="number" id="num-workers" value="4" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm p-2" />
                </div>
                <div class="border-t pt-6 space-y-4">
                  <h3 class="text-lg font-semibold text-gray-800">数据处理选项</h3>
                  <div class="flex items-center justify-between">
                    <span class="text-sm font-medium text-gray-700">平衡数据</span>
                    <label class="relative inline-flex items-center cursor-pointer">
                      <input type="checkbox" id="balanced" class="sr-only peer" />
                      <div class="w-11 h-6 bg-gray-200 rounded-full peer peer-focus:ring-4 peer-focus:ring-indigo-300 peer-checked:bg-indigo-600"></div>
                    </label>
                  </div>
                  <div class="flex items-center justify-between">
                    <span class="text-sm font-medium text-gray-700">数据增强</span>
                    <label class="relative inline-flex items-center cursor-pointer">
                      <input type="checkbox" id="augmented" class="sr-only peer" />
                      <div class="w-11 h-6 bg-gray-200 rounded-full peer peer-focus:ring-4 peer-focus:ring-indigo-300 peer-checked:bg-indigo-600"></div>
                    </label>
                  </div>
                  <div id="augment-options" class="pl-4 space-y-4 hidden">
                    <div class="flex items-center justify-between">
                      <span class="text-sm text-gray-600">翻转</span><label class="relative inline-flex items-center cursor-pointer">
                        <input type="checkbox" id="augment-flip" class="sr-only peer" />
                        <div class="w-11 h-6 bg-gray-200 rounded-full peer peer-checked:bg-indigo-600"></div>
                      </label>
                    </div>
                    <div class="flex items-center justify-between">
                      <span class="text-sm text-gray-600">平移</span><label class="relative inline-flex items-center cursor-pointer">
                        <input type="checkbox" id="augment-offset" class="sr-only peer" />
                        <div class="w-11 h-6 bg-gray-200 rounded-full peer peer-checked:bg-indigo-600"></div>
                      </label>
                    </div>
                    <div class="flex items-center justify-between">
                      <span class="text-sm text-gray-600">缩放</span><label class="relative inline-flex items-center cursor-pointer">
                        <input type="checkbox" id="augment-scale" class="sr-only peer" />
                        <div class="w-11 h-6 bg-gray-200 rounded-full peer peer-checked:bg-indigo-600"></div>
                      </label>
                    </div>
                    <div class="flex items-center justify-between">
                      <span class="text-sm text-gray-600">旋转</span><label class="relative inline-flex items-center cursor-pointer">
                        <input type="checkbox" id="augment-rotate" class="sr-only peer" />
                        <div class="w-11 h-6 bg-gray-200 rounded-full peer peer-checked:bg-indigo-600"></div>
                      </label>
                    </div>
                    <div class="flex items-center justify-between">
                      <span class="text-sm text-gray-600">噪声</span><label class="relative inline-flex items-center cursor-pointer">
                        <input type="checkbox" id="augment-noise" class="sr-only peer" />
                        <div class="w-11 h-6 bg-gray-200 rounded-full peer peer-checked:bg-indigo-600"></div>
                      </label>
                    </div>
                  </div>
                </div>
                <div class="flex space-x-4 pt-6 border-t">
                  <button id="start-btn" class="w-full bg-indigo-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 transition">开始训练</button>
                  <button id="pause-btn" class="w-full bg-yellow-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-yellow-600 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-yellow-400 transition disabled:bg-gray-400 disabled:cursor-not-allowed" disabled>暂停</button>
                </div>
              </div>
            </div>
          </div>

          <!-- 模型推理面板 -->
          <div class="bg-white p-6 rounded-xl shadow-lg">
            <h2 class="text-2xl font-bold mb-6 border-b pb-4">模型推理</h2>
            <div class="space-y-4">
              <div>
                <label for="model-file" class="block text-sm font-medium text-gray-700">选择模型文件</label>
                <input type="file" id="model-file" class="mt-1 block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-indigo-50 file:text-indigo-700 hover:file:bg-indigo-100" />
              </div>
              <button id="start-inference-btn" class="w-full bg-cyan-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-cyan-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-cyan-500 transition disabled:bg-gray-400">开始推理</button>
              <div id="inference-status" class="text-center text-sm text-gray-500 h-5"></div>
            </div>
          </div>
        </div>

        <!-- 右侧：显示区域 -->
        <div class="lg:col-span-2 space-y-8">
          <!-- 训练进度 -->
          <div class="bg-white p-6 rounded-xl shadow-lg">
            <h2 class="text-2xl font-bold mb-4">训练进度</h2>
            <div class="space-y-4">
              <div class="flex justify-between items-center font-mono">
                <span>Epoch: <span id="epoch-count">0 / 0</span></span>
                <span id="status-text" class="text-sm font-semibold text-gray-500">尚未开始</span>
              </div>
              <div class="w-full bg-gray-200 rounded-full h-4">
                <div id="progress-bar" class="bg-green-500 h-4 rounded-full transition-all" style="width: 0%"></div>
              </div>
              <div class="text-center font-mono text-sm text-gray-600">
                Batch: <span id="batch-count">0 / 0</span>
              </div>
            </div>
          </div>

          <!-- 图表 -->
          <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
            <div class="bg-white p-6 rounded-xl shadow-lg h-80">
              <h3 class="text-xl font-bold mb-4">损失 (Loss)</h3><canvas id="lossChart"></canvas>
            </div>
            <div class="bg-white p-6 rounded-xl shadow-lg h-80">
              <h3 class="text-xl font-bold mb-4">准确率 (Accuracy)</h3><canvas id="accChart"></canvas>
            </div>
          </div>

          <!-- 推理结果显示 -->
          <div id="inference-results-panel" class="bg-white p-6 rounded-xl shadow-lg hidden">
            <h2 class="text-2xl font-bold mb-4">推理结果</h2>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 text-center">
              <div>
                <h4 class="font-semibold mb-2">Input Image</h4>
                <img id="input-image" src="https://placehold.co/400x400/EEEEEE/AAAAAA?text=Input" class="w-full h-auto bg-gray-200 rounded-lg" />
              </div>
              <div>
                <h4 class="font-semibold mb-2">Ground Truth (Label)</h4>
                <img id="label-image" src="https://placehold.co/400x400/EEEEEE/AAAAAA?text=Label" class="w-full h-auto bg-gray-200 rounded-lg" />
              </div>
              <div>
                <h4 class="font-semibold mb-2">Model Output</h4>
                <img id="output-image" src="https://placehold.co/400x400/EEEEEE/AAAAAA?text=Output" class="w-full h-auto bg-gray-200 rounded-lg" />
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <script>
      document.addEventListener('DOMContentLoaded', function () {
        // --- DOM元素获取 ---
        const startBtn = document.getElementById('start-btn')
        const pauseBtn = document.getElementById('pause-btn')
        const hyperparamsForm = document.getElementById('hyperparams-form')
        const statusText = document.getElementById('status-text')
        const progressBar = document.getElementById('progress-bar')
        const epochCount = document.getElementById('epoch-count')
        const batchCount = document.getElementById('batch-count')
        const augmentedCheckbox = document.getElementById('augmented')
        const augmentOptions = document.getElementById('augment-options')
      
        // 折叠面板元素
        const hyperparamsHeader = document.getElementById('hyperparams-header')
        const hyperparamsContent = document.getElementById('hyperparams-content')
        const hyperparamsToggleIcon = document.getElementById('hyperparams-toggle-icon')
      
        // 推理面板元素
        const startInferenceBtn = document.getElementById('start-inference-btn')
        const modelFileInput = document.getElementById('model-file')
        const inferenceStatus = document.getElementById('inference-status')
        const inferenceResultsPanel = document.getElementById('inference-results-panel')
        const inputImage = document.getElementById('input-image')
        const labelImage = document.getElementById('label-image')
        const outputImage = document.getElementById('output-image')
      
        // --- Chart.js 初始化 ---
        const createChart = (ctx, label) =>
          new Chart(ctx, {
            type: 'line',
            data: { labels: [], datasets: [{ label, data: [], borderColor: label === 'Loss' ? 'rgb(239, 68, 68)' : 'rgb(34, 197, 94)', backgroundColor: label === 'Loss' ? 'rgba(239, 68, 68, 0.1)' : 'rgba(34, 197, 94, 0.1)', borderWidth: 2, pointRadius: 0, tension: 0.4, fill: true }] },
            options: { scales: { y: { beginAtZero: true } }, animation: { duration: 200 }, maintainAspectRatio: false }
          })
        const lossChart = createChart(document.getElementById('lossChart').getContext('2d'), 'Loss')
        const accChart = createChart(document.getElementById('accChart').getContext('2d'), 'Accuracy')
      
        // --- Socket.IO 连接 ---
        const socket = io()
        let trainingInProgress = false
      
        // --- 函数定义 ---
        function resetUI() {
          progressBar.style.width = '0%'
          epochCount.textContent = '0 / 0'
          batchCount.textContent = '0 / 0'
          statusText.textContent = '尚未开始'
          lossChart.data.labels = []
          lossChart.data.datasets[0].data = []
          lossChart.update('none')
          accChart.data.labels = []
          accChart.data.datasets[0].data = []
          accChart.update('none')
        }
      
        function setControlsState(isTraining) {
          trainingInProgress = isTraining
          startBtn.disabled = isTraining
          pauseBtn.disabled = !isTraining
          hyperparamsForm.querySelectorAll('input').forEach((input) => (input.disabled = isTraining))
          if (isTraining) {
            startBtn.textContent = '训练中...'
            startBtn.classList.add('cursor-not-allowed', 'bg-indigo-400')
            startBtn.classList.remove('hover:bg-indigo-700')
          } else {
            startBtn.textContent = '开始训练'
            startBtn.classList.remove('cursor-not-allowed', 'bg-indigo-400')
            startBtn.classList.add('hover:bg-indigo-700')
            pauseBtn.textContent = '暂停'
            pauseBtn.classList.remove('bg-green-500', 'hover:bg-green-600')
            pauseBtn.classList.add('bg-yellow-500', 'hover:bg-yellow-600')
          }
        }
      
        // --- 事件监听 ---
        // 折叠/展开超参数面板
        hyperparamsHeader.addEventListener('click', () => {
          hyperparamsContent.classList.toggle('hidden')
          hyperparamsToggleIcon.classList.toggle('rotate-180')
        })
      
        augmentedCheckbox.addEventListener('change', () => {
          augmentOptions.classList.toggle('hidden', !augmentedCheckbox.checked)
        })
      
        // 开始训练
        startBtn.addEventListener('click', () => {
          resetUI()
          setControlsState(true)
          statusText.textContent = '正在启动...'
          const params = {
            epochs: document.getElementById('epochs').value,
            batch_size: document.getElementById('batch-size').value,
            num_workers: document.getElementById('num-workers').value,
            balanced: document.getElementById('balanced').checked,
            augmented: document.getElementById('augmented').checked,
            augment_flip: document.getElementById('augment-flip').checked,
            augment_offset: document.getElementById('augment-offset').checked,
            augment_scale: document.getElementById('augment-scale').checked,
            augment_rotate: document.getElementById('augment-rotate').checked,
            augment_noise: document.getElementById('augment-noise').checked
          }
          fetch('/start_training', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(params) })
        })
      
        // 暂停/继续训练
        pauseBtn.addEventListener('click', () => {
          fetch('/toggle_pause', { method: 'POST' })
            .then((res) => res.json())
            .then((data) => {
              if (data.status === 'paused') {
                pauseBtn.textContent = '继续'
                pauseBtn.classList.replace('bg-yellow-500', 'bg-green-500')
                pauseBtn.classList.replace('hover:bg-yellow-600', 'hover:bg-green-600')
                statusText.textContent = '已暂停'
              } else {
                pauseBtn.textContent = '暂停'
                pauseBtn.classList.replace('bg-green-500', 'bg-yellow-500')
                pauseBtn.classList.replace('hover:bg-green-600', 'hover:bg-yellow-600')
                statusText.textContent = '训练中...'
              }
            })
        })
      
        // 开始推理
        startInferenceBtn.addEventListener('click', () => {
          if (modelFileInput.files.length === 0) {
            inferenceStatus.textContent = '请先选择一个模型文件！'
            return
          }
          inferenceStatus.textContent = '正在启动推理...'
          startInferenceBtn.disabled = true
          inferenceResultsPanel.classList.remove('hidden')
      
          // 在实际应用中，您可能需要上传文件或传递文件名
          const payload = { model_file: modelFileInput.files[0].name }
      
          fetch('/start_inference', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) })
        })
      
        // --- Socket.IO 事件处理 ---
        socket.on('progress_update', function (data) {
          if (!trainingInProgress) return
          statusText.textContent = '训练中...'
          const progress = (data.batch_iter / data.total_batches) * 100
          progressBar.style.width = progress + '%'
          epochCount.textContent = `${data.epoch} / ${data.total_epochs}`
          batchCount.textContent = `${data.batch_iter} / ${data.total_batches}`
          const label = `${data.epoch}-${data.batch_iter}`
          lossChart.data.labels.push(label)
          lossChart.data.datasets[0].data.push(data.loss)
          accChart.data.labels.push(label)
          accChart.data.datasets[0].data.push(data.accuracy)
          lossChart.update()
          accChart.update()
        })
      
        socket.on('training_finished', function (data) {
          setControlsState(false)
          statusText.textContent = '训练完成！'
          progressBar.style.width = '100%'
          progressBar.classList.replace('bg-green-500', 'bg-blue-500')
        })
      
        socket.on('inference_image_update', function (data) {
          inferenceStatus.textContent = '推理完成！'
          inputImage.src = data.input_url
          labelImage.src = data.label_url
          outputImage.src = data.output_url
          startInferenceBtn.disabled = false
        })
      })
    </script>
  </body>
</html>
